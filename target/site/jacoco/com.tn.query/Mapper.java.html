<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>Mapper.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">tn-query</a> &gt; <a href="index.source.html" class="el_package">com.tn.query</a> &gt; <span class="el_source">Mapper.java</span></div><h1>Mapper.java</h1><pre class="source lang-java linenums">package com.tn.query;

import java.text.ParseException;
import java.text.SimpleDateFormat;
import java.time.LocalDate;
import java.time.LocalDateTime;
import java.util.Date;
import java.util.Objects;
import java.util.function.Function;

public class Mapper extends Named
{
<span class="fc" id="L13">  private static final SimpleDateFormat DATE_FORMAT = new SimpleDateFormat(&quot;yyyy-M-d&quot;);</span>
<span class="fc" id="L14">  private static final SimpleDateFormat DATE_TIME_MINUTES_FORMAT = new SimpleDateFormat(&quot;yyyy-M-d'T'H:m&quot;);</span>
<span class="fc" id="L15">  private static final SimpleDateFormat DATE_TIME_SECONDS_FORMAT = new SimpleDateFormat(&quot;yyyy-M-d'T'H:m:s&quot;);</span>
<span class="fc" id="L16">  private static final SimpleDateFormat DATE_TIME_MILLISECONDS_FORMAT = new SimpleDateFormat(&quot;yyyy-M-d'T'H:m:s.S&quot;);</span>
  private static final int MAX_DATE_LENGTH = 10;

  private static final String QUOTE_SINGLE = &quot;'&quot;;

  private static final String QUOTE_DOUBLE = &quot;\&quot;&quot;;
  private static final char TIME_SEPARATOR = ':';
  private static final char MILLI_SEPARATOR = '.';
  private static final int TIME_WITH_MINUTES = 1;

  private final String type;
  private final Function&lt;String, Object&gt; map;

  private Mapper(String name, String type, Function&lt;String, Object&gt; map)
  {
<span class="fc" id="L31">    super(name);</span>
<span class="fc" id="L32">    this.type = type;</span>
<span class="fc" id="L33">    this.map = map;</span>
<span class="fc" id="L34">  }</span>

  public Object map(String object)
  {
    try
    {
<span class="fc" id="L40">      return this.map.apply(object);</span>
    }
<span class="nc" id="L42">    catch (Exception e)</span>
    {
<span class="nc bnc" id="L44" title="All 2 branches missed.">      throw e instanceof QueryException ? (QueryException)e : new QueryException(&quot;Failed to map: &quot; + this.name() + &quot;, value: &quot; + object, e);</span>
    }
  }

  public static Mapper toBoolean(String name)
  {
<span class="fc" id="L50">    return new Mapper(name, boolean.class.getCanonicalName(), Boolean::parseBoolean);</span>
  }

  public static Mapper toByte(String name)
  {
<span class="fc" id="L55">    return new Mapper(name, byte.class.getCanonicalName(), Byte::parseByte);</span>
  }

  public static Mapper toChar(String name)
  {
<span class="fc" id="L60">    return new Mapper(</span>
      name,
<span class="fc" id="L62">      char.class.getCanonicalName(),</span>
      s -&gt; {
<span class="pc bpc" id="L64" title="1 of 2 branches missed.">        if (s.length() != 1) throw new QueryException(&quot;Failed to map: &quot; + name + &quot;, value: &quot; + s);</span>
<span class="fc" id="L65">        return s.charAt(0);</span>
      }
    );
  }

  public static Mapper toDate(String name)
  {
<span class="fc" id="L72">    return new Mapper(</span>
      name,
<span class="fc" id="L74">      Date.class.getCanonicalName(),</span>
<span class="fc bfc" id="L75" title="All 2 branches covered.">      s -&gt; isPossibleDate(s) ? parseDate(s) : parseDateTime(s)</span>
    );
  }

  public static Mapper toDouble(String name)
  {
<span class="fc" id="L81">    return new Mapper(name, double.class.getCanonicalName(), Double::parseDouble);</span>
  }

  public static Mapper toFloat(String name)
  {
<span class="fc" id="L86">    return new Mapper(name, float.class.getCanonicalName(), Float::parseFloat);</span>
  }

  public static Mapper toInt(String name)
  {
<span class="fc" id="L91">    return new Mapper(name, int.class.getCanonicalName(), Integer::parseInt);</span>
  }

  public static Mapper toLocalDate(String name)
  {
<span class="fc" id="L96">    return new Mapper(name, LocalDate.class.getCanonicalName(), LocalDate::parse);</span>
  }

  public static Mapper toLocalDateTime(String name)
  {
<span class="fc" id="L101">    return new Mapper(name, LocalDateTime.class.getCanonicalName(), LocalDateTime::parse);</span>
  }

  public static Mapper toLong(String name)
  {
<span class="fc" id="L106">    return new Mapper(name, long.class.getCanonicalName(), Long::parseLong);</span>
  }

  public static Mapper toShort(String name)
  {
<span class="fc" id="L111">    return new Mapper(name, short.class.getCanonicalName(), Short::parseShort);</span>
  }

  public static Mapper toString(String name)
  {
<span class="fc" id="L116">    return new Mapper(name, String.class.getCanonicalName(), Mapper::parseString);</span>
  }

  @Override
  public boolean equals(Object other)
  {
<span class="pc bpc" id="L122" title="2 of 4 branches missed.">    return this == other || (</span>
      other != null &amp;&amp;
<span class="pc bpc" id="L124" title="1 of 2 branches missed.">      getClass().equals(other.getClass()) &amp;&amp;</span>
<span class="pc bpc" id="L125" title="1 of 2 branches missed.">      Objects.equals(this.name(), ((Mapper)other).name()) &amp;&amp;</span>
<span class="pc bpc" id="L126" title="1 of 2 branches missed.">      Objects.equals(this.type, ((Mapper)other).type)</span>
    );
  }

  @Override
  public int hashCode()
  {
<span class="nc" id="L133">    return this.name().hashCode();</span>
  }

  @Override
  public String toString()
  {
<span class="nc" id="L139">    return name() + &quot;: &quot; + this.type;</span>
  }

  private static boolean isPossibleDate(String s)
  {
<span class="fc bfc" id="L144" title="All 2 branches covered.">    return s.length() &lt;= MAX_DATE_LENGTH;</span>
  }

  private static Date parseDate(String s)
  {
    try
    {
<span class="fc" id="L151">      return DATE_FORMAT.parse(s);</span>
    }
<span class="nc" id="L153">    catch (ParseException e)</span>
    {
<span class="nc" id="L155">      throw new QueryParseException(&quot;Invalid date: &quot; + s, e);</span>
    }
  }

  private static Date parseDateTime(String s)
  {
    try
    {
<span class="fc bfc" id="L163" title="All 4 branches covered.">      if (s.chars().filter(c -&gt; c == TIME_SEPARATOR).count() == TIME_WITH_MINUTES)</span>
      {
<span class="fc" id="L165">        return DATE_TIME_MINUTES_FORMAT.parse(s);</span>
      }
      else
      {
<span class="pc bpc" id="L169" title="1 of 2 branches missed.">        return s.indexOf(MILLI_SEPARATOR) &gt; -1 ? DATE_TIME_MILLISECONDS_FORMAT.parse(s) : DATE_TIME_SECONDS_FORMAT.parse(s);</span>
      }
    }
<span class="nc" id="L172">    catch (ParseException e)</span>
    {
<span class="nc" id="L174">      throw new QueryParseException(&quot;Invalid date-time: &quot; + s, e);</span>
    }
  }

  private static String parseString(String s)
  {
<span class="pc bpc" id="L180" title="1 of 2 branches missed.">    if (s == null) return null;</span>

<span class="fc bfc" id="L182" title="All 2 branches covered.">    if (s.startsWith(QUOTE_SINGLE)) s = s.substring(QUOTE_SINGLE.length());</span>
<span class="fc bfc" id="L183" title="All 2 branches covered.">    if (s.endsWith(QUOTE_SINGLE)) s = s.substring(0, s.length() - QUOTE_SINGLE.length());</span>

<span class="fc bfc" id="L185" title="All 2 branches covered.">    if (s.startsWith(QUOTE_DOUBLE)) s = s.substring(QUOTE_DOUBLE.length());</span>
<span class="fc bfc" id="L186" title="All 2 branches covered.">    if (s.endsWith(QUOTE_DOUBLE)) s = s.substring(0, s.length() - QUOTE_DOUBLE.length());</span>

<span class="fc" id="L188">    return s;</span>
  }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.3.201901230119</span></div></body></html>